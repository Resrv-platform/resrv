<!DOCTYPE html>
<html lang="en">
<head>
  <title>Client Portal</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Your client portal powered by RESRV" />
  <link rel="icon" href="https://rms.resrv.nl/favicon.ico" />
  <script>window.clientportal_debug = true;</script>

  <!-- Routing Script + Meta via API -->
  <script>
    const formdata = new FormData();
    formdata.append("client_domain", window.location.hostname); // auto detect domain

    const requestOptions = {
      method: "POST",
      body: formdata,
      redirect: "follow"
    };

    fetch("https://rms.resrv.nl/api/1.1/wf/get_domain", requestOptions)
      .then((response) => response.json())
      .then((data) => {
        console.log("Received from Bubble:", data);

        if (data.redirect_url) {
          const iframe = document.getElementById("clientportal_iframe");
          iframe.src = data.redirect_url + "&clientside_routing=true";

          // Update meta info if present
          if (data.meta) {
            clientportalChangeMeta(data.meta);
          }
        }
      })
      .catch((error) => console.error("API error:", error));

    function clientportalChangeMeta(meta) {
      if (meta.documentTitle) document.title = meta.documentTitle;

      if (meta.description) {
        let desc = document.querySelector("meta[name='description']");
        if (!desc) {
          desc = document.createElement("meta");
          desc.setAttribute("name", "description");
          document.head.appendChild(desc);
        }
        desc.setAttribute("content", meta.description);
      }

      if (meta.openGraphMetaTags) {
        for (const [property, content] of Object.entries(meta.openGraphMetaTags)) {
          let tag = document.querySelector(`meta[property="${property}"]`);
          if (!tag) {
            tag = document.createElement("meta");
            tag.setAttribute("property", property);
            document.head.appendChild(tag);
          }
          tag.setAttribute("content", content);
        }
      }

      if (meta.linkTypes) {
        for (const [rel, href] of Object.entries(meta.linkTypes)) {
          let link = document.querySelector(`link[rel="${rel}"]`);
          if (!link) {
            link = document.createElement("link");
            link.setAttribute("rel", rel);
            document.head.appendChild(link);
          }
          link.setAttribute("href", href);
        }
      }
    }
  </script>

  <script id="clientportal_router"
    data-base-path-to="/indexclient"
    data-base-path-from="/">
    (function () {
      const routerScript = document.getElementById("clientportal_router");
      const basePathTo = routerScript.getAttribute("data-base-path-to") || "/";
      const basePathFrom = routerScript.getAttribute("data-base-path-from") || "/";
      let lastUrl = window.location.pathname + window.location.search + window.location.hash;

      function debugLog(...args) {
        if (window.clientportal_debug) console.log("[clientportal]", ...args);
      }

      window.addEventListener("message", (event) => {
        const data = event.data;

        if (data?.type === "clientportal:navigate") {
          const newPath = data.path;
          if (newPath !== lastUrl) {
            const action = clientportalClientSideRouter(basePathTo, basePathFrom, newPath, lastUrl);
            if (action.action === "replace") {
              history.replaceState({}, "", action.url);
              lastUrl = newPath;
              debugLog("URL updated:", action.url);
            }
          }
        }

        if (data?.clientportal?.meta) {
          clientportalChangeMeta(data.clientportal.meta);
        }
      });

      function clientportalClientSideRouter(toPath, fromPath, newUrl, oldUrl) {
        try {
          const cleanNewUrl = newUrl.split("?")[0];
          const queryParams = new URLSearchParams(newUrl.split("?")[1] || "");
          queryParams.delete("clientside_routing");

          let transformedUrl = cleanNewUrl;
          if (toPath !== "/") transformedUrl = transformedUrl.replace(toPath, fromPath);
          if (queryParams.toString()) {
            transformedUrl += "?" + queryParams.toString();
          }

          if (oldUrl !== transformedUrl) {
            return { action: "replace", url: transformedUrl };
          }
        } catch (err) {
          debugLog("Routing error:", err.message);
        }

        return { action: "none", url: null };
      }
    })();
  </script>
</head>
<body>
  <iframe
    id="clientportal_iframe"
    src=""
    style="position:fixed; top:0; left:0; bottom:0; right:0; width:100%; height:100%; border:none; margin:0; padding:0; overflow:hidden; z-index:999999;"
    allow="fullscreen"
  >
    Your browser doesn't support iframes.
  </iframe>
</body>
</html>
