<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Clientomgeving</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }
    iframe {
      border: none;
      width: 100%;
      height: 100%;
    }
  </style>

  <script>
  const clientDomain = window.location.hostname;

  fetch("https://rms.resrv.nl/version-test/api/1.1/wf/receive-domain", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ domain: clientDomain })
  })
  .then(res => res.json())
  .then(data => {
    console.log("Domain sent to Bubble:", clientDomain);
  })
  .catch(err => console.error("Failed to send domain:", err));
</script>
</head>
<body>
  <iframe id="appFrame" allow="fullscreen"></iframe>

  <script>
    const iframe = document.getElementById('appFrame');
    const base = "https://rms.resrv.nl/clientindex";
    const client = "client=" + encodeURIComponent(window.location.hostname);

    // âœ… Zet alle queryparams + hash om in een string
    function getFullPath() {
      return window.location.pathname + window.location.search + window.location.hash;
    }

    // âœ… Bouw volledige iframe src met client param
    function buildIframeUrl(path) {
      const url = new URL(base + path, window.location.origin);
      const existingParams = new URLSearchParams(url.search);

      // Voeg client= toe (overschrijft als nodig)
      existingParams.set("client", window.location.hostname);
      url.search = existingParams.toString();

      return url.href;
    }

    // âœ… Initieel laden
    function updateIframeSrc() {
      iframe.src = buildIframeUrl(getFullPath());
    }

    updateIframeSrc();

    // âœ… Navigatie: terugknop of Bubble stuurt nieuwe path
    window.addEventListener("popstate", updateIframeSrc);

    // âœ… Ontvang berichten van Bubble (navigatie & domein)
    window.addEventListener("message", (event) => {
      if (event.origin !== "https://rms.resrv.nl") return;

      const data = event.data;

      // Bubble navigeert intern
      if (data?.type === "bubble:navigate") {
  let newPath = data.path;
  const currentPath = getFullPath();

  // ðŸ‘‡ Detect if Bubble navigates to /indexclient â†’ replace with /
  const browserPath = newPath === "/indexclient" ? "/" : newPath;

  if (browserPath !== currentPath) {
    history.pushState({}, '', browserPath); // update browser URL to clean version
    iframe.src = buildIframeUrl(newPath);   // iframe still loads /indexclient
  }
}

      // Bubble vraagt om het client-domein
      if (data?.type === "bubble:request-origin") {
        iframe.contentWindow.postMessage({
          type: "client:domain",
          domain: window.location.hostname
        }, "*");
      }
    });
  </script>
</body>
</html>
