<!DOCTYPE html>
<html lang="en">
<head>
  <title>Client Portal</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Your client portal powered by RESRV">
  <link rel="icon" href="https://rms.resrv.nl/favicon.ico" />
  <script>window.clientportal_debug = true;</script>

  <!-- Routing Script -->
  <script id="clientportal_router"
    data-base-path-to="/indexclient"
    data-base-path-from="/">
    (function () {
      const routerScript = document.getElementById("clientportal_router");
      const basePathTo = routerScript.getAttribute("data-base-path-to") || "/";
      const basePathFrom = routerScript.getAttribute("data-base-path-from") || "/";
      let lastUrl = window.location.pathname + window.location.search + window.location.hash;

      function debugLog(...args) {
        if (window.clientportal_debug) console.log("[clientportal]", ...args);
      }

      window.addEventListener("message", (event) => {
        const data = event.data;

        if (data?.type === "clientportal:navigate") {
          const newPath = data.path;
          if (newPath !== lastUrl) {
            const action = clientportalClientSideRouter(basePathTo, basePathFrom, newPath, lastUrl);
            if (action.action === "replace") {
              history.replaceState({}, "", action.url);
              lastUrl = newPath;
              debugLog("URL updated:", action.url);
            }
          }
        }

        if (data?.clientportal?.meta) {
          clientportalChangeMeta(data.clientportal.meta);
        }
      });

      function clientportalClientSideRouter(toPath, fromPath, newUrl, oldUrl) {
        try {
          const cleanNewUrl = newUrl.split("?")[0];
          const queryParams = new URLSearchParams(newUrl.split("?")[1] || "");
          queryParams.delete("clientside_routing");

          let transformedUrl = cleanNewUrl;
          if (toPath !== "/") transformedUrl = transformedUrl.replace(toPath, fromPath);
          if (queryParams.toString()) {
            transformedUrl += "?" + queryParams.toString();
          }

          if (oldUrl !== transformedUrl) {
            return { action: "replace", url: transformedUrl };
          }
        } catch (err) {
          debugLog("Routing error:", err.message);
        }

        return { action: "none", url: null };
      }

      function clientportalChangeMeta(meta) {
        if (meta.documentTitle) document.title = meta.documentTitle;
        if (meta.description) {
          const desc = document.querySelector("meta[name='description']");
          if (desc) desc.setAttribute("content", meta.description);
        }
        if (meta.openGraphMetaTags) {
          for (const [property, content] of Object.entries(meta.openGraphMetaTags)) {
            const tag = document.querySelector(`meta[property="${property}"]`);
            if (tag && content) tag.setAttribute("content", content);
          }
        }
        if (meta.linkTypes) {
          for (const [rel, href] of Object.entries(meta.linkTypes)) {
            const link = document.querySelector(`link[rel="${rel}"]`);
            if (link && href) link.setAttribute("href", href);
          }
        }
      }

      // On page load: update iframe src based on browser path
      window.addEventListener("DOMContentLoaded", () => {
        const path = window.location.pathname + window.location.search + window.location.hash;
        const iframe = document.getElementById("clientportal_iframe");
        const url = "https://rms.resrv.nl" + path + (path.includes("?") ? "&" : "?") + "clientside_routing=true";
        iframe.src = url;
        debugLog("Set initial iframe src to:", url);
      });

      // On browser back/forward: update iframe src too
      window.addEventListener("popstate", () => {
        const path = window.location.pathname + window.location.search + window.location.hash;
        const iframe = document.getElementById("clientportal_iframe");
        const url = "https://rms.resrv.nl" + path + (path.includes("?") ? "&" : "?") + "clientside_routing=true";
        iframe.src = url;
        debugLog("Updated iframe src (back/forward) to:", url);
      });
    })();
  </script>
</head>
<body>
  <iframe
    id="clientportal_iframe"
    src=""
    style="position:fixed; top:0; left:0; bottom:0; right:0; width:100%; height:100%; border:none; margin:0; padding:0; overflow:hidden; z-index:999999;"
    allow="fullscreen"
  >
    Your browser doesn't support iframes.
  </iframe>
</body>
</html>
